<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Hello Operator</title>
  </head>
  <body>

    <h1>Hello Operator</h1>

    <script type="module">

import { Synth } from "./js/synth.js";

var dx7 = new Synth();

var keys = "awsedftgyhujkolp;".split("");
var keyMap = {};
keys.forEach((k, i) => keyMap[k] = i + 72);

document.documentElement.addEventListener("keydown", function(e) {
  if (e.key == "]") {
    dx7.algorithm = (dx7.algorithm + 1) % 33
    if (dx7.algorithm == 0) dx7.algorithm++;
    console.log(dx7.algorithm);
    return;
  }
  if (e.key == "[") {
    dx7.algorithm -= 1;
    if (dx7.algorithm < 1) dx7.algorithm = 32;
    console.log(dx7.algorithm);
    return;
  }
  if ("123456".includes(e.key)) {
    var operator = dx7.operators[e.key - 1];
    operator.enabled = "enabled" in operator ? !operator.enabled : false;
    console.log(e.key, operator.enabled);
    return;
  }
  var note = keyMap[e.key];
  if (!note) return;
  var f = dx7.midiToFrequency(note);
  dx7.noteOn(f, 127);
});

document.documentElement.addEventListener("keyup", function(e) {
  var note = keyMap[e.key];
  if (!note) return;
  var f = dx7.midiToFrequency(note);
  dx7.noteOff(f);
});

const NOTE = 144;
const ENCODER = 176;
const DISCRETE = 192;
const PITCH = 224;

const VOLUME = 7;
const MODULATION = 1;

var onMIDI = function(e) {
  var [ type, key, value ] = e.data;
  console.log(type, key, value);
  switch (type) {
    case NOTE:
      var f = dx7.midiToFrequency(key);
      if (value) {
        dx7.noteOn(f, value);
      } else {
        dx7.noteOff(f);
      }
      break;

    case DISCRETE:
      var operator = dx7.operators[key];
      operator.enabled = "enabled" in operator ? !operator.enabled : false;
      console.log(key + 1, operator.enabled);
      break;
  }
}

var getMidi = async function() {
  var midi = await navigator.requestMIDIAccess();
  for (var [ key, entry ] of midi.inputs) {
    entry.onmidimessage = onMIDI;
    console.log(entry);
  }
};

getMidi();

    </script>
  </body>
</html>