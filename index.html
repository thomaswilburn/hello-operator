<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Hello Operator</title>
  </head>
  <body>

    <rotary-encoder id=volume min=0 max=100 value=100>volume</rotary-encoder>

    <operator-panel></operator-panel>

    <script type="module">

import { Synth } from "./js/synth.js";
import { MIDITarget } from "./js/midi.js";
import "./js/rotaryEncoder.js";
import "./js/operatorPanel.js";

var dx7 = new Synth();

var keys = "awsedftgyhujkolp;".split("");
var keyMap = {};
keys.forEach((k, i) => keyMap[k] = i + 72);

document.documentElement.addEventListener("keydown", function(e) {
  if (e.key == "]") {
    dx7.algorithm = (dx7.algorithm + 1) % 33
    if (dx7.algorithm == 0) dx7.algorithm++;
    console.log(dx7.algorithm);
    return;
  }
  if (e.key == "[") {
    dx7.algorithm -= 1;
    if (dx7.algorithm < 1) dx7.algorithm = 32;
    console.log(dx7.algorithm);
    return;
  }
  if ("123456".includes(e.key)) {
    return dx7.toggleOperator(e.key - 1);
  }
  var note = keyMap[e.key];
  if (!note) return;
  var f = dx7.midiToFrequency(note);
  dx7.noteOn(f, 127);
});

document.documentElement.addEventListener("keyup", function(e) {
  var note = keyMap[e.key];
  if (!note) return;
  var f = dx7.midiToFrequency(note);
  dx7.noteOff(f);
});

var midi = new MIDITarget();

midi.on("noteon", function(e) {
  var { key, pressure } = e.data;
  var f = dx7.midiToFrequency(key);
  dx7.noteOn(f, pressure);
});

midi.on("noteoff", function(e) {
  var f = dx7.midiToFrequency(e.data.key);
  dx7.noteOff(f);
});

// volume is 24
// rotary encoders are 16-23
// buttons are 102-109
// modulation is 1
//pitch is 

var controlMap = {
  24: "#volume"
};

for (var key in controlMap) {
  controlMap[key] = document.querySelector(controlMap[key]);
}

midi.on("controlchange", function(e) {
  var { controller, value } = e.data;
  if (controller in controlMap) {
    var ui = controlMap[controller];
    ui.scaledValue = value / 127;
    return;
  }
  var index = controller - 102;
  var enabled = !!value;
  dx7.toggleOperator(index);
});

midi.on("ready", function(e) {
  // o2 keyboard seems to ignore this
  midi.sendReset();
});

    </script>
  </body>
</html>